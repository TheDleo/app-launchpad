<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
		<link rel="shortcut icon" href="favicon.ico"/>
		<title>LaunchPad v0.2.15</title>
		
		<!-- Standard CSS -->
		<link rel="stylesheet" href="themes/df-default/jquery-ui-1.9.1.custom.css" type="text/css" />
		<link rel="stylesheet" href="css/layout.css" type="text/css" />
		
		<!-- jQuery Imports -->
		<script src="jQuery/jquery-1.8.2.min.js"></script>
		<script src="jQuery/jquery-ui-1.9.1.custom.min.js"></script>
		<script src="jQuery/plugins/jquery.blockUI.js"></script>
		
		<!-- DF Imports -->
		<script src="dfcore/dfio.js"></script>
		<script src="dfcore/dferr.js"></script>
		
		<!-- LaunchPad JS -->
		<script src="js/base64/base64.js"></script>
		
		<script>

var User = null;
var AppGrps = null;
var Apps = null;

var tab_counter = 0;
var tab_content = '';
var $tabs = null;

var max_chars_image = 13;
var max_chars_button = 20;

function resizeUi() {
    var h = $(window).height();
    var w = $(window).width();
    $("#appSelector").css('height', h-120 );
    $(".ui-tabs-panel").css('height', h-180 );
};

var resizeTimer = null;

$(window).bind('resize', function() {
    if (resizeTimer) clearTimeout(resizeTimer);
    resizeTimer = setTimeout(resizeUi, 100);
});

function doSignIn() {
	$( "#loginDialog" ).dialog("open");
}

function showSignInControls(show) {
	if(show) {
		$('#dfControl1').html('Please [<a id="dfSignInLink" class="dfPointer dfTxtHeader3">Log In</a>]');
		$( "#dfSignInLink" ).click(function() {$( "#loginDialog" ).dialog("open");});
	} else {
		$('#dfControl1').html('Welcome! <span class="dfTxtHeader3">'+User.FullName+'</span> [<a id="dfSignOutLink" class="dfPointer"> Log Out </a>]');
		$( "#dfSignOutLink" ).click(function() {$( "#logoffDialog" ).dialog("open");});
		$('#Password').val("");
	}
}

function performSignIn() {
	$( "#loginDialog" ).dialog("close");
	$('#dfControl1').html('<i>Logging In, Please Wait...</i>');
	userio.post(JSON.stringify({UserName: $('#UserName').val(),Password:base64_encode($('#Password').val())}), null, "/Login");
}

function doSignOut() {
	$("#logoffDialog").dialog("open");
}

function reportError(errorMsg,data) {
	var str = errorMsg.toString();
	if(str.indexOf("Login request") != -1) {
		$("#loginErrorMessage").html('<b>'+str+'</b><br/><br/>');
		doSignIn();
	} else {
		if(User != null) {
			$('#errorMsg').html(errorMsg);
			$('#errorDialog').dialog('open');
		} else {
			if(str.indexOf("[QUERYFAILED]: Record with Id") == -1) { 
				$("#loginErrorMessage").html('<b>Enter your User ID and Password and click Sign In below;</b><br/><br/>');
			}
			doSignIn();
		}
	}
}

var appio = new DFRequest({
	service: 'System',
	resource: '/App',
	success: function(json,request) {
		if(!parseErrors(json,reportError)) {
			Apps = CommonUtilities.flattenResponse(json);
			initTabs();
			addDefaultTab();
		}
	},
	error: function(err) {
		reportError(err.statusText);
	}
});

var appGrpio = new DFRequest({
	service: 'System',
	resource: '/AppGroup',
	success: function(json,request) {
		if(!parseErrors(json,reportError)) {
			AppGrps = CommonUtilities.flattenResponse(json);
			appio.retrieve({order:"Label"});
		}
	},
	error: function(err) {
		reportError(err.statusText);
	}
});


function getAppsFor(appGrpId) {
	var tmp = [];
	for(var i in Apps) {
		if(Apps[i].AppGroupIds && Apps[i].AppGroupIds.length>0&& Apps[i].AppGroupIds.indexOf(","+appGrpId+",") != -1) {
			tmp[tmp.length] = Apps[i];
		}
	}
	return tmp;
}

function getAppById(id) {
	for(var i in Apps) {
		if(Apps[i].Id == id) {
			return Apps[i];
		}
	}
}

var userio = new DFRequest({
	service: 'User',
	resource: '/Session',
	success: function(json,request) {
		if(!parseErrors(json,reportError)) {
			if(json.UserName) {
				User = json;
				appGrpio.retrieve({order:"Name"});
				showSignInControls(false);
			} else {
				showSignInControls(true);
				doSignIn();
			}
		}
	},
	error: function(err) {
		if(User != null) {
			reportError(err.statusText);
		} else {
			$("#loginErrorMessage").html('<b>'+err.statusText+'</b><br/><br/>');
			doSignIn();
		}
	}
});

var tabOptions = {
	tabTemplate: "<li><span class='cRight dfPointer ui-icon ui-icon-close'>Remove Tab</span><a href='#{href}'>#{label}</a></li>",
	add: function( event, ui ) {
		if(tab_content) $( ui.panel ).append(tab_content);
	}
};

function initTabs() {
	$('#dfContent').html('<div id="leftControl" class="cLeft"><div id="navigation"></div></div><div id="rightContent"><div class="cLeft cW100"><div id="appSelector" class="cW100"><ul></ul></div></div></div>');
	$tabs = $( "#appSelector").tabs(tabOptions);
	$('#leftControl').html('<div id="navigation"></div>');
	setup();
}

function createDisplay(id,href,longdesc) {
	var tmp = '<iframe class="displayFrame" frameborder="0" marginheight="0" marginwidth="0" ';
	if(id) tmp += 'name="'+id+'"';
	if(href) tmp += 'src="'+href+'" ';
	if(longdesc) tmp += 'longdesc="'+longdesc+'" ';
	tmp += '></iframe>';
	return tmp;
}

function addTabFunctions(tab) {
	$("span",tab).unbind('click');
	$("span",tab).click(function() {
		var $parent = $( this ).parent();
		var index = $( "li", $tabs ).index( $parent );
		$parent.find('a').each(function(){
			var id = parseInt($(this).attr('href').substring('#tabs-'.length));
			$('.btn'+id).button( "option", "icons", {secondary:'ui-icon-play'} );
		});
		$tabs.tabs( "remove", index );
		if($( "#appSelector span.ui-icon-close" ).length < 1) addDefaultTab();
	});
}


function addDefaultTab() {
	tab_content = createDisplay('DEFAULT_TAB','defaulttab.html','Default Tab');;
	addTabFunctions($tabs.tabs( "add", "#tabs-DEFAULT",'Welcome!'));
	resizeUi();
}

function clearTabs() {
	$('#rightContent').load('<div class="cLeft cW100"><div id="appSelector" class="cW100"><ul></ul></div></div>');
}

function destroySpace() {
	$('#dfContent').load("splash.html");
}

function showContent(sw) {
	if(sw) {
		$('#leftControl').fadeIn(250);
		$('#rightContent').fadeIn(250);
		$( "#leftControl" ).show( 'fade', 1500 );
		$( "#rightContent" ).show( 'fade', 3500 );
	} else {
		$( "#leftControl" ).hide( 'fade', 2000 );
		$( "#rightContent" ).hide( 'fade', 2000 ,function(){destroySpace();});
	}
}

function getTicket() {
	return User.ticket;
}

function setTicket(ticket) {
	User.ticket = ticket;
}

function getTicketExpires() {
	return User.ticket_expiry;
}

function hasTicketExpired() {
	var future = new Number(User.ticket_expiry*1000);
	var now = new Date().getTime();
	if(future-now >= 0) return false;
	return true;
}

function refreshTicket(opts) {
	var callback = opts.success;
	var errCallback = opts.error;
	new DFRequest({
		service: 'User',
		resource: '/Ticket',
		success: function(json) {
			var err = checkFailure(json);
			if(err) {
				doSignIn();
			} else {
				User.ticket = json.ticket;
				User.ticket_expiry = json.ticket_expiry;
				if(callback) callback(json);
			}
		},
		error: function (msg) {
			if(errCallback) {
				errCallback(msg);
			} else {
				throw(msg);
			}
		}
	}).retrieve();
}

function getCurrentTicket(opts) {
	if(hasTicketExpired()) {
		refreshTicket(opts);
	} else {
		opts.success(getTicket());
	}
}

function addTab(app) {
	getCurrentTicket({
		success: function(ticket) {
			var url = app.Url;
			if(!(app.IsUrlExternal=="true")) {
				if(url.indexOf('/') > 0 || url.indexOf('/') == -1) {
					url = '/'+url;
				}
				url = getCurrentServer()+'/apps/'+app.Name+url;
			}
			if(url.indexOf('?') != -1) {
				if(url.substr(-1) === "&" ) {
					url += 'svr='+escape(getCurrentServer())+'&';
				} else {
					url += '&svr='+escape(getCurrentServer())+'&';
				}
			} else {
				url += '?svr='+escape(getCurrentServer())+'&';
			}
			url += 'app='+escape(app.Name)+'&ticket='+escape(ticket)+'&';
			tab_content = createDisplay("disp" + app.Id,url,app.Description);
			addTabFunctions($tabs.tabs( "add", "#tabs-" + app.Id, app.Label ));
			$tabs.tabs( "option", "selected", $('#appSelector ul a[href="#tabs-' + app.Id+'"]').parent().index() );
			resizeUi();
		},
		error: function(msg,faultString) {
			$('.btn'+app.Id).button( "option", "icons", {secondary:'ui-icon-play'} );
			$().dfui('sessionExpired',faultString);
		}
	});
}

function makeNavButton(id,icon,label) {
	var tmpBtn = $('<button class="appButton btn'+id+'" id="app'+id+'"></button>');
	if(label) {
		if(label.length <= max_chars_image) tmpBtn.append(icon);
		if(label.length > max_chars_button) label = label.substring(0,max_chars_button);
		label = label.replace(/ /g,'&nbsp;');
		tmpBtn.append(label);
	} else {
		tmpBtn.append(icon);
		tmpBtn.append("No Label");
	}
	return tmpBtn;
}

function icon(app) {
	var ico = '';
	if(app.IsUrlExternal=="true") {
		var appUrl = app.Url;
		var tmp = appUrl.substring(appUrl.lastIndexOf('//')+2);
		if(tmp.indexOf('/') != -1) {
			tmp = tmp.substring(0,tmp.lastIndexOf('/'));
		}
		tmp = appUrl.substring(0,appUrl.lastIndexOf('//')+2)+tmp;
		ico = tmp+'/favicon.ico';
	} else {
		ico = getCurrentServer()+'/apps/'+app.Name+'/favicon.ico';
	}
	return '<img src="'+ico+'" onerror="this.style.display=\'none\'" class="cLeft" width="16" height="16" border="0"/>';
}

function setup() {
	var display = $("#navigation");
	for(var i in AppGrps) {
		display.append('<h3><a href="#">'+AppGrps[i].Name+'</a></h3>');
		var appsList = $('<div></div>');
		
		var apps = getAppsFor( AppGrps[i].Id);
		
		for(var j in apps) {
			if(apps[j].Name == "LaunchPad") continue;
			appsList.append(this.makeNavButton(apps[j].Id,icon(apps[j]),apps[j].Label));
		}
		
		appsList.append('<br/>');
		display.append(appsList);
		
	}
	
	/* all apps group*/
	display.append('<h3><a href="#">All Applications</a></h3>');
	var appsList = $('<div></div>');
	for(var j in Apps) {
		if(Apps[j].Name == "LaunchPad") continue;
		appsList.append(this.makeNavButton(Apps[j].Id,icon(Apps[j]),Apps[j].Label));
	}
	appsList.append('<br/>');
	display.append(appsList);
	
	display.accordion({ autoHeight: false });
	
	$( ".appButton" ).button({
		text: true,
		icons: {
			secondary: 'ui-icon-play'
		}
	}).click(function() {
		var appId = $(this).attr('id');
		if(appId && User) {
			var id = appId.substring(3);
			var app = getAppById(id);
			if(app) {
				if($(this).button( "option", "icons" ).secondary == 'ui-icon-play') {
					$('.btn'+id).button( "option", "icons", {secondary:'ui-icon-seek-next'} );
					addTab(app);
				}
				var xindex = 0;
				$('[role*="tab"]').each(function(){
					var $this = $(this);
					var tx = $this.attr("aria-controls");
					if(tx && tx.indexOf("tabs-") == 0) {
						if(tx == "tabs-"+app.Id) {
							$('#appSelector').tabs( "option", "active", xindex );
						} else {
							xindex++;
						}
					}
				});
			}
		}
	});
}


$(document).ready(function() {
	
	$(document).ajaxStart($.blockUI).ajaxStop($.unblockUI);

	$('#UserName').keydown(function (e){
		if(e.keyCode == 13){
			$('#Password').focus();
		}
	});

	$('#Password').keydown(function (e){
		if(e.keyCode == 13){
			performSignIn();
		}
	});
	
	$('#loginDialog').dialog({
		resizable: false,
		modal: true,
		autoOpen: false,
		buttons: {
			"Sign In": function() {
				performSignIn();
			},
			Cancel: function() {
				window.history.back();
			}
		}
	});
	
	$('#logoffDialog').dialog({
		resizable: false,
		modal: true,
		autoOpen: false,
		buttons: {
			"Log Off": function() {
				User = null;
				userio.post(null,null,"/Logout");
				showSignInControls(true);
				$(this).dialog( "close" );
				showContent(false);
			},
			Cancel: function() {
				$( this ).dialog( "close" );
			}
		}
	});
	
	$("#errorDialog").dialog({
		resizable: false,
		modal: true,
		autoOpen: false,
		closeOnEscape: false,
		buttons: {	}
	});
	
	$( "#dfSignInLink" ).click(function() {
		doSignIn();
	});
	
	destroySpace();
	userio.retrieve();
	
});


		</script>
		
		<!-- Initialize the system and start the application -->
	</head>
	<body>
		<div id="main_content">
			<div class="cTxtLeft dfHeader ui-corner-all" id="status">
				<div id="LOGO" class="cLeft cW50"><img src="gfx/logos/logo.png" border="0"/></div>
				<div class="cLeft cW50 cTxtRight" id="dfControl1">
					Please [<a id="dfSignInLink" class="dfPointer dfTxtHeader3">Log In</a>] To Continue!
				</div>
				<div class="cLeft cW50 cTxtRight" id="dfControl2"></div>
				<div class="cLeft cW50 cTxtRight" id="dfControl3"></div>
				<div class="cLeft cW50 cTxtRight" id="dfControl4"></div>
				<div class="cClear"><!-- --></div>
			</div>
			<div class="cTxtLeft" id="dfContent"></div>
			<div class="cClear"><!-- --></div>
			<div class="dfTxtSmallBold cP1" align="center">
				&copy;<script>document.write(new Date().getFullYear());</script> DreamFactory&trade;, All Rights Reserved.
			</div>
		</div>
		<div id="loginDialog" title="Please Log In..." class="cTxtLeft">
			<div>
				<div id="loginErrorMessage">Please enter your User Name and Password below to sign in;</div>
				<div class="cM1">
					<div class="cLeft cW3333 cTxtRight dfTxtBold">
						<span class="cM1">Username:&nbsp;</span>
					</div>
					<div class="cLeft cW6666">
						<input type="text" size="25" class="ui-corner-all" name="UserName" id="UserName" value=""/>
					</div>
					<div class="cClear"><!-- --></div>
				</div>
				<div class="cM1">
					<div class="cLeft cW3333 cTxtRight dfTxtBold">
						<span class="cM1">Password:&nbsp;</span>
					</div>
					<div class="cLeft cW6666">
						<input type="password" size="25" class="ui-corner-all" name="Password" id="Password" value=""/>
					</div>
					<div class="cClear"><!-- --></div>
				</div>
			</div>
		</div>
		<div id="logoffDialog" title="Log Out" class="cTxtLeft">
			<p>
				Are you sure you want to log out of the application? All unsaved work will
				be lost!
			</p>
		</div>
		<div id="errorDialog" title="An Error Has Occured..." class="cTxtLeft">
			<p class="ui-state-error ui-corner-all cP1">
				<span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
				<span id="errorMsg"><!--  --></span>
			</p>
		</div>
	</body>
</html>